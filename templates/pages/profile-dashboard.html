{% comment %} profile-dashboard.html {% endcomment %}
{% load static %}
{% load i18n %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Colorify Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .dropdown {
        position: relative;
        display: inline-block;
      }
      .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f9f9f9;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
        z-index: 1;
        right: 0;
      }
      .dropdown-content a {
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
      }
      .dropdown-content a:hover {
        background-color: #f1f1f1;
      }
      .show {
        display: block;
      }
      /* {% comment %} Activity overview
        .project-row {
        transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out;
        opacity: 1;
        max-height: 100px;
        overflow: hidden;
      }
      .project-row.fade-out {
        opacity: 0;
        max-height: 0;
      }
      .project-row.fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          max-height: 0;
        }
        to {
          opacity: 1;
          max-height: 100px;
        }
      }
     {% endcomment %} */
    </style>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      /* Ensure full height layout */
      html, body {
        height: 100%;
      }
      .full-height-container {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .expandable-content {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
    </style>
  </head>


  <body class="bg-gray-100 h-screen overflow-hidden">
    <div class="h-screen flex flex-col p-3 gap-3">
      <!-- Top Navbar -->
      <nav class="bg-white shadow-md rounded-xl">
        <div class="mx-auto">
          <div class="flex justify-between h-16">
            <div class="flex">
              <div class="flex-shrink-0 flex items-center ml-3">
                <img
                  class="h-8 w-auto"
                  src="{% static 'images/logo.png' %}"
                  alt="Colorify logo"
                />
                <span class="ml-2 text-xl font-bold text-indigo-600">COLORIFY</span>
              </div>
            </div>
            <div class="flex items-center mr-8">
              <button
                class="p-1 rounded-full text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
              >
                <span class="sr-only">View notifications</span>
                <svg
                  class="h-6 w-6"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                  />
                </svg>
              </button>
              <div class="ml-3 relative">
                <div>
                  <button
                    type="button"
                    class="flex items-center max-w-xs bg-white rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                    id="user-menu-button"
                    aria-expanded="false"
                    aria-haspopup="true"
                  >
                    {% if user.profile_photo %}
                    <img
                      class="h-8 w-8 rounded-full"
                      src="{{ user.profile_photo.url }}"
                      alt=""
                    />
                    {% else %}
                      <img
                        class="h-8 w-8 rounded-full"
                        src="{% static 'default-avatar.png' %}"
                        alt="Default Avatar"
                      />
                    {% endif %}
                    <span class="ml-2 text-sm font-medium text-gray-700">
                      {{ user.first_name }} {{ user.last_name }}
                    </span>
                    <svg
                      class="ml-1 h-5 w-5 text-gray-400"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                      aria-hidden="true"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </button>
                </div>

                <!-- Dropdown menu -->
                <div
                  id="user-menu-dropdown"
                  class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none"
                  role="menu"
                  aria-orientation="vertical"
                  aria-labelledby="user-menu-button"
                  tabindex="-1"
                >
        
                  {% comment %} <a
                    href="#"
                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                    role="menuitem"
                    tabindex="-1"
                    >Settings</a
                  > {% endcomment %}
                  <a
                    href="{% url 'account_logout' %}"
                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                    role="menuitem"
                    tabindex="-1"
                    >Sign out</a
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>

      <main class="flex-1 min-h-0 flex flex-col">
        <!-- Sidebar -->
        {% comment %} <div
          class="w-16 bg-white shadow-md hidden flex-col items-center py-4 space-y-6 rounded-xl h-screen mt-8 md:flex"
        >
          <button class="p-2 rounded-lg hover:bg-gray-100">
            <svg
              class="h-6 w-6 text-gray-500"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              />
            </svg>
          </button>

          <button class="p-2 rounded-lg hover:bg-gray-100">
            <svg
              class="h-6 w-6 text-gray-500"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              />
            </svg>
          </button>

          <!-- Add more sidebar icons here -->
        </div> {% endcomment %}

        <!-- Main Content -->
        <!-- Content Container: Uses calc() to leave bottom gap -->
        <div class="h-full pb-6">
          
          <!-- My Account Card: Full height minus padding -->
          <div class="h-full bg-white rounded-lg shadow-md p-4 sm:p-6 lg:p-8 flex flex-col overflow-hidden">
            
            <!-- Header: Fixed height -->
            <div class="flex-shrink-0 mb-6">
              <h2 class="text-xl font-semibold">My Account</h2>
            </div>
            
            <!-- Scrollable Content Area: Takes remaining space -->
            <div class="flex-1 min-h-0 overflow-y-auto">
              <div class="space-y-6 lg:space-y-8">
                
                <!-- Profile Section -->
                <section class="flex flex-col lg:flex-row gap-6 lg:gap-8">
                  
                  <!-- Profile Photo Column -->
                  <div class="w-full lg:w-80 flex-shrink-0">
                    <div class="bg-teal-500 rounded-lg overflow-hidden mb-3 aspect-square max-w-64 mx-auto lg:mx-0 flex items-center justify-center" id="profilePhotoContainer">
                      {% if user.profile_photo %}
                        <img 
                          src="{{ user.profile_photo.url }}" 
                          alt="Profile Picture" 
                          class="w-full h-full object-cover" 
                          id="profilePhotoDisplay"
                        />
                      {% else %}
                        <div class="w-full h-full flex items-center justify-center bg-gray-200">
                          <span class="text-gray-500">No profile photo</span>
                        </div>
                      {% endif %}
                    </div>
                    <input type="file" id="profilePhotoInput" class="hidden" accept="image/*" onchange="handleProfilePhotoChange(event)">
                    <div class="max-w-64 mx-auto lg:mx-0 space-y-2">
                      <button
                        onclick="document.getElementById('profilePhotoInput').click()"
                        class="w-full bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm hover:bg-gray-300 transition-colors"
                      >
                        Edit Profile Photo
                      </button>
                      {% if user.profile_photo %}
                      <button
                        onclick="deleteProfilePhoto()"
                        class="w-full bg-red-100 text-red-700 px-4 py-2 rounded-full text-sm hover:bg-red-200 transition-colors"
                      >
                        Remove Photo
                      </button>
                      {% endif %}
                    </div>
                  </div>
                  
                  <!-- Profile Details Column -->
                  <div class="flex-1 min-w-0">
                    <div class="space-y-6">
                      
                      <!-- Name Section -->
                      <div>
                        <div id="nameView">
                          <p class="text-sm text-gray-500 flex items-center mb-1">
                            Name
                            <svg
                              class="h-3 w-3 ml-1 text-gray-400 cursor-pointer hover:text-gray-600 transition-colors"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                              xmlns="http://www.w3.org/2000/svg"
                              onclick="toggleEdit('name')"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                              ></path>
                            </svg>
                          </p>
                          <p class="font-semibold text-lg" id="nameText">
                            {% if user.first_name %}
                                {{ user.first_name }} {{ user.last_name }}
                            {% else %}
                                {{ user.username }}
                            {% endif %}
                          </p>
                        </div>
                        <div id="nameEdit" class="hidden space-y-3">
                          <div>
                            <label for="firstNameInput" class="block text-sm text-gray-500 mb-1">First Name</label>
                            <input type="text" id="firstNameInput" class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="{{ user.first_name }}">
                          </div>
                          <div>
                            <label for="lastNameInput" class="block text-sm text-gray-500 mb-1">Last Name</label>
                            <input type="text" id="lastNameInput" class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="{{ user.last_name }}">
                          </div>
                          <div class="flex gap-2">
                            <button onclick="saveName()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">Save</button>
                            <button onclick="cancelEdit('name')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Gender and Designation Grid -->
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Gender Section -->
                        <div>
                          <div id="genderView">
                            <p class="text-sm text-gray-500 flex items-center mb-1">
                              Gender
                              <svg
                                class="h-3 w-3 ml-1 text-gray-400 cursor-pointer hover:text-gray-600 transition-colors"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg"
                                onclick="toggleEdit('gender')"
                              >
                                <path
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                                ></path>
                              </svg>
                            </p>
                            <p class="font-medium" id="genderText">
                              {% if user.gender == 'M' %}
                                Male
                              {% elif user.gender == 'F' %}
                                Female
                              {% elif user.gender == 'O' %}
                                Other
                              {% else %}
                                Not specified
                              {% endif %}
                            </p>
                          </div>
                          <div id="genderEdit" class="hidden space-y-3">
                            <select id="genderInput" class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                              <option value="Male" {% if user.gender == 'M' %}selected{% endif %}>Male</option>
                              <option value="Female" {% if user.gender == 'F' %}selected{% endif %}>Female</option>
                              <option value="Other" {% if user.gender == 'O' %}selected{% endif %}>Other</option>
                            </select>
                            <div class="flex gap-2">
                              <button onclick="saveEdit('gender')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">Save</button>
                              <button onclick="cancelEdit('gender')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Designation Section -->
                        <div>
                          <div id="designationView">
                            <p class="text-sm text-gray-500 flex items-center mb-1">
                              Designation
                              <svg
                                class="h-3 w-3 ml-1 text-gray-400 cursor-pointer hover:text-gray-600 transition-colors"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg"
                                onclick="toggleEdit('designation')"
                              >
                                <path
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                                ></path>
                              </svg>
                            </p>
                            <p class="font-medium" id="designationText">
                              {% if user.designation %}
                                {{ user.designation }}
                              {% else %}
                                Not specified
                              {% endif %}
                            </p>
                          </div>
                          <div id="designationEdit" class="hidden space-y-3">
                            <input 
                              type="text" 
                              id="designationInput" 
                              class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                              value="{% if user.designation %}{{ user.designation }}{% endif %}"
                              placeholder="Enter designation"
                            >
                            <div class="flex gap-2">
                              <button onclick="saveEdit('designation')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">Save</button>
                              <button onclick="cancelEdit('designation')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Password Section -->
                      <div>
                        <div id="passwordView">
                          <p class="text-sm text-gray-500 flex items-center mb-1">
                            Password
                            <svg
                              class="h-3 w-3 ml-1 text-gray-400 cursor-pointer hover:text-gray-600 transition-colors"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                              xmlns="http://www.w3.org/2000/svg"
                              onclick="toggleEdit('password')"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                              ></path>
                            </svg>
                          </p>
                          <p class="font-medium" id="passwordText">••••••••••</p>
                        </div>
                        <div id="passwordEdit" class="hidden space-y-3">
                          <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
                            <div>
                              <label for="currentPasswordInput" class="block text-sm text-gray-500 mb-1">Current Password</label>
                              <input type="password" id="currentPasswordInput" class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                              <label for="newPasswordInput" class="block text-sm text-gray-500 mb-1">New Password</label>
                              <input type="password" id="newPasswordInput" class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                              <label for="confirmPasswordInput" class="block text-sm text-gray-500 mb-1">Confirm New Password</label>
                              <input type="password" id="confirmPasswordInput" class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                          </div>
                          <div class="flex gap-2">
                            <button onclick="savePassword()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">Save</button>
                            <button onclick="cancelEdit('password')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Delete Account Button -->
                      <div>
                        <button
                          class="text-red-600 text-sm border border-red-300 rounded-full px-6 py-2 hover:bg-red-50 hover:border-red-500 transition-colors"
                        >
                          Delete Account Permanently
                        </button>
                      </div>
                    </div>
                  </div>
                </section>
                
                <!-- Details Sections Grid -->
                <section class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 lg:gap-8">
                  
                  <!-- Address Section -->
                  <div class="space-y-4">
                    <h4 class="font-semibold text-lg flex items-center">
                      Address
                      <svg
                        class="h-4 w-4 ml-2 text-gray-500 cursor-pointer hover:text-gray-700 transition-colors"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg"
                        onclick="toggleEdit('address')"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                        ></path>
                      </svg>
                    </h4>
                    <div id="addressView" class="space-y-4">
                      <div>
                        <p class="text-sm text-gray-500 mb-1">Address Line</p>
                        <p class="font-medium" id="addressLineText">
                          {% if user.address_line %}{{ user.address_line }}{% else %}Not specified{% endif %}
                        </p>
                      </div>
                      <div>
                        <p class="text-sm text-gray-500 mb-1">City</p>
                        <p class="font-medium" id="cityText">
                          {% if user.city %}{{ user.city }}{% else %}Not specified{% endif %}
                        </p>
                      </div>
                      <div>
                        <p class="text-sm text-gray-500 mb-1">State</p>
                        <p class="font-medium" id="stateText">
                          {% if user.state %}{{ user.state }}{% else %}Not specified{% endif %}
                        </p>
                      </div>
                      <div>
                        <p class="text-sm text-gray-500 mb-1">Country</p>
                        <p class="font-medium" id="countryText">
                          {% if user.country %}{{ user.country }}{% else %}Not specified{% endif %}
                        </p>
                      </div>
                    </div>
                    <div id="addressEdit" class="hidden space-y-3">
                      <input 
                        type="text" 
                        id="addressLineInput" 
                        class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                        value="{% if user.address_line %}{{ user.address_line }}{% endif %}" 
                        placeholder="Address Line"
                      >
                      <input 
                        type="text" 
                        id="cityInput" 
                        class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                        value="{% if user.city %}{{ user.city }}{% endif %}" 
                        placeholder="City"
                      >
                      <input 
                        type="text" 
                        id="stateInput" 
                        class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                        value="{% if user.state %}{{ user.state }}{% endif %}" 
                        placeholder="State"
                      >
                      <input 
                        type="text" 
                        id="countryInput" 
                        class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                        value="{% if user.country %}{{ user.country }}{% endif %}" 
                        placeholder="Country"
                      >
                      <div class="flex gap-2">
                        <button onclick="saveAddress()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">Save</button>
                        <button onclick="cancelEdit('address')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Contact Details Section -->
                  <div class="space-y-4">
                    <h4 class="font-semibold text-lg flex items-center">
                      Contact Details
                      <svg
                        class="h-4 w-4 ml-2 text-gray-500 cursor-pointer hover:text-gray-700 transition-colors"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg"
                        onclick="toggleEdit('contact')"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                        ></path>
                      </svg>
                    </h4>
                    <div id="contactView" class="space-y-4">
                      <div>
                        <p class="text-sm text-gray-500 mb-1">Phone Number</p>
                        <p class="font-medium" id="phoneText">
                          {% if user.phone_number %}{{ user.phone_number }}{% else %}Not specified{% endif %}
                        </p>
                      </div>
                      <div>
                        <p class="text-sm text-gray-500 mb-1">Email</p>
                        <p class="font-medium" id="emailText">{{ user.email }}</p>
                      </div>
                    </div>
                    <div id="contactEdit" class="hidden space-y-3">
                      <input 
                        type="tel" 
                        id="phoneInput" 
                        class="border border-gray-300 rounded-lg px-3 py-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                        value="{% if user.phone_number %}{{ user.phone_number }}{% endif %}" 
                        placeholder="Phone Number"
                      >
                      <p class="text-sm text-gray-400">Email cannot be changed</p>
                      <div class="flex gap-2">
                        <button onclick="savePhoneNumber()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">Save</button>
                        <button onclick="cancelEdit('contact')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Subscription Section -->
                  <div class="space-y-4 lg:col-span-2 xl:col-span-1">
                    <h4 class="font-semibold text-lg">Subscription</h4>
                    <ul class="space-y-3">
                      <li class="flex items-center">
                        <span class="w-3 h-3 bg-gray-400 rounded-full mr-3 flex-shrink-0"></span>
                        <span class="font-medium">Month 1</span>
                      </li>
                      <li class="flex items-center">
                        <span class="w-3 h-3 bg-gray-900 rounded-full mr-3 flex-shrink-0"></span>
                        <span class="font-medium">Month 2</span>
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs ml-auto font-medium">Current</span>
                      </li>
                      <li class="flex items-center">
                        <span class="w-3 h-3 bg-gray-200 rounded-full mr-3 flex-shrink-0"></span>
                        <span class="text-gray-400 font-medium">Month 3</span>
                      </li>
                    </ul>
                  </div>
                </section>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </body>
</html>

{% comment %} Togglable sidebar {% endcomment %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const menuButton = document.getElementById('user-menu-button');
    const dropdown = document.getElementById('user-menu-dropdown');
    
    menuButton.addEventListener('click', function() {
      const isExpanded = menuButton.getAttribute('aria-expanded') === 'true';
      
      // Toggle the dropdown
      dropdown.classList.toggle('hidden');
      
      // Update aria-expanded
      menuButton.setAttribute('aria-expanded', !isExpanded);
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      if (!menuButton.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.classList.add('hidden');
        menuButton.setAttribute('aria-expanded', 'false');
      }
    });
  });
</script>

{% comment %} Account Operations {% endcomment %}
<script>
  // Toggle between view and edit mode
  function toggleEdit(field) {
    document.getElementById(`${field}View`).classList.add("hidden");
    document.getElementById(`${field}Edit`).classList.remove("hidden");
  }

  // Save the edited value
  function saveEdit(field) {
    if (field === 'gender') {
      saveGender();
    } else if (field === 'designation') {
      saveDesignation();
    } else if (field === 'password') {
      savePassword();
    }
  }

  // Special function to save name with first and last name fields
  function saveName() {
    const firstName = document.getElementById('firstNameInput').value;
    const lastName = document.getElementById('lastNameInput').value;
    
    // Update the display text
    document.getElementById('nameText').textContent = firstName + ' ' + lastName;
    
    // Make an API call to update the first name
    fetch('/core/users/update-first-name/', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        first_name: firstName
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('First name updated successfully');
      
      // After updating first name, update last name
      return fetch('/core/users/update-last-name/', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          last_name: lastName
        })
      });
    })
    .then(response => response.json())
    .then(data => {
      console.log('Last name updated successfully');
    })
    .catch(error => {
      console.error('Error updating name:', error);
    });
    
    // Hide edit view, show regular view
    document.getElementById('nameView').classList.remove("hidden");
    document.getElementById('nameEdit').classList.add("hidden");
  }

  // Function to save gender
  function saveGender() {
    const genderSelect = document.getElementById('genderInput');
    const selectedOption = genderSelect.options[genderSelect.selectedIndex].value;
    let genderCode;
    
    // Convert display value to DB code
    if (selectedOption === 'Male') genderCode = 'M';
    else if (selectedOption === 'Female') genderCode = 'F';
    else genderCode = 'O';
    
    // Update the display text
    document.getElementById('genderText').textContent = selectedOption;
    
    // Make API call to update gender
    fetch('/core/users/update-gender/', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        gender: genderCode
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.message) {
        console.log('Gender updated successfully');
      }
    })
    .catch(error => {
      console.error('Error updating gender:', error);
    });
    
    // Hide edit view, show regular view
    document.getElementById('genderView').classList.remove("hidden");
    document.getElementById('genderEdit').classList.add("hidden");
  }

  // Function to save designation
  function saveDesignation() {
    const designation = document.getElementById('designationInput').value;
    
    // Update the display text
    document.getElementById('designationText').textContent = designation;
    
    // Make API call to update designation
    fetch('/core/users/update-designation/', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        designation: designation
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.message) {
        console.log('Designation updated successfully');
      }
    })
    .catch(error => {
      console.error('Error updating designation:', error);
    });
    
    // Hide edit view, show regular view
    document.getElementById('designationView').classList.remove("hidden");
    document.getElementById('designationEdit').classList.add("hidden");
  }

  // Function to save password
  function savePassword() {
    const currentPassword = document.getElementById('currentPasswordInput').value;
    const newPassword = document.getElementById('newPasswordInput').value;
    const confirmPassword = document.getElementById('confirmPasswordInput').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
      alert('All password fields are required');
      return;
    }
    
    if (newPassword !== confirmPassword) {
      alert('New passwords do not match');
      return;
    }
    
    // Make API call to update password
    fetch('/core/users/change-password/', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        current_password: currentPassword,
        new_password: newPassword,
        confirm_password: confirmPassword
      })
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.error || 'Failed to update password');
        });
      }
      return response.json();
    })
    .then(data => {
      alert('Password updated successfully');
      
      // Clear password fields
      document.getElementById('currentPasswordInput').value = '';
      document.getElementById('newPasswordInput').value = '';
      document.getElementById('confirmPasswordInput').value = '';
      
      // Hide edit view, show regular view
      document.getElementById('passwordView').classList.remove("hidden");
      document.getElementById('passwordEdit').classList.add("hidden");
    })
    .catch(error => {
      alert(error.message || 'Error updating password');
      console.error('Error updating password:', error);
    });
  }

  // Function to save address
  function saveAddress() {
    const addressLine = document.getElementById('addressLineInput').value;
    const city = document.getElementById('cityInput').value;
    const state = document.getElementById('stateInput').value;
    const country = document.getElementById('countryInput').value;
    
    // Update the display text
    document.getElementById('addressLineText').textContent = addressLine || 'Not specified';
    document.getElementById('cityText').textContent = city || 'Not specified';
    document.getElementById('stateText').textContent = state || 'Not specified';
    document.getElementById('countryText').textContent = country || 'Not specified';
    
    // Make API call to update address
    fetch('/core/users/update-address/', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        address_line: addressLine,
        city: city,
        state: state,
        country: country
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.message) {
        console.log('Address updated successfully');
      }
    })
    .catch(error => {
      console.error('Error updating address:', error);
    });
    
    // Hide edit view, show regular view
    document.getElementById('addressView').classList.remove("hidden");
    document.getElementById('addressEdit').classList.add("hidden");
  }

  // Function to save phone number
  function savePhoneNumber() {
    const phoneNumber = document.getElementById('phoneInput').value;
    
    // Update the display text
    document.getElementById('phoneText').textContent = phoneNumber || 'Not specified';
    
    // Make API call to update phone number
    fetch('/core/users/update-phone-number/', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        phone_number: phoneNumber
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.message) {
        console.log('Phone number updated successfully');
      }
    })
    .catch(error => {
      console.error('Error updating phone number:', error);
    });
    
    // Hide edit view, show regular view
    document.getElementById('contactView').classList.remove("hidden");
    document.getElementById('contactEdit').classList.add("hidden");
  }

  // Cancel editing and revert changes
  function cancelEdit(field) {
    document.getElementById(`${field}View`).classList.remove("hidden");
    document.getElementById(`${field}Edit`).classList.add("hidden");
  }

  // Helper function to get CSRF token from cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Function to handle profile photo selection
  function handleProfilePhotoChange(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file type
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
      alert('Invalid file type. Only JPEG, PNG, and GIF are allowed.');
      return;
    }
    
    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      alert('File size too large. Maximum size is 5 MB.');
      return;
    }
    
    // Show loading state
    const container = document.getElementById('profilePhotoContainer');
    container.innerHTML = `<div class="flex items-center justify-center w-full h-full">
      <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white"></div>
    </div>`;
    
    // Upload to server
    uploadProfilePhoto(file);
  }

  // Function to upload profile photo
  function uploadProfilePhoto(file) {
    const formData = new FormData();
    formData.append('profile_photo', file);
    
    fetch('/core/users/update-profile-photo/', {
      method: 'POST',
      credentials: 'include',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Accept': 'application/json'
      },
      body: formData
    })
    .then(response => {
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('text/html')) {
        return response.text().then(html => {
          console.error('Server returned HTML:', html);
          throw new Error('Server error occurred');
        });
      }
      
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.error || 'Failed to upload profile photo');
        });
      }
      return response.json();
    })
    .then(data => {
      console.log('Upload successful:', data);
      
      // Update the image with cache busting
      const container = document.getElementById('profilePhotoContainer');
      const timestamp = new Date().getTime();
      const newImageUrl = data.profile_photo_url + '?t=' + timestamp;
      
      container.innerHTML = `
        <img src="${newImageUrl}" 
             alt="Profile Picture" 
             class="w-full h-auto" 
             id="profilePhotoDisplay">
      `;
      
      // Update/create the remove button
      const existingRemoveBtn = document.querySelector('button[onclick="deleteProfilePhoto()"]');
      if (!existingRemoveBtn) {
        const editButton = document.querySelector('button[onclick="document.getElementById(\'profilePhotoInput\').click()"]');
        const removeButton = document.createElement('button');
        removeButton.className = 'w-full bg-red-100 text-red-700 px-3 py-2 rounded-full text-sm mt-2';
        removeButton.textContent = 'Remove Photo';
        removeButton.onclick = deleteProfilePhoto;
        editButton.parentNode.appendChild(removeButton);
      }
    })
    .catch(error => {
      console.error('Upload failed:', error);
      alert(error.message);
      
      // Reset to default state
      const container = document.getElementById('profilePhotoContainer');
      container.innerHTML = `
        <div class="w-full h-full flex items-center justify-center bg-gray-200">
          <span class="text-gray-500">Upload failed. Please try again.</span>
        </div>
      `;
    });
  }


  
  // Function to delete profile photo
  function deleteProfilePhoto() {
    if (!confirm('Are you sure you want to remove your profile photo?')) {
      return;
    }
    
    // Show loading state
    const container = document.getElementById('profilePhotoContainer');
    container.innerHTML = `<div class="flex items-center justify-center w-full h-full">
      <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white"></div>
    </div>`;
    
    fetch('/core/users/delete-profile-photo/', {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      }
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.error || 'Failed to delete profile photo');
        });
      }
      return response.json();
    })
    .then(data => {
      console.log('Profile photo deleted successfully');
      
      // Replace the image with a placeholder
      const container = document.getElementById('profilePhotoContainer');
      container.innerHTML = `
        <div class="w-full h-full flex items-center justify-center bg-gray-200">
          <span class="text-gray-500">No profile photo</span>
        </div>
      `;
      
      // Remove the delete button
      const deleteButton = document.querySelector('button[onclick="deleteProfilePhoto()"]');
      if (deleteButton) {
        deleteButton.remove();
      }
    })
    .catch(error => {
      alert(error.message || 'Error deleting profile photo');
      console.error('Error deleting profile photo:', error);
      
      // Reset container on error
      const container = document.getElementById('profilePhotoContainer');
      container.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-200">
        <span class="text-gray-500">Failed to delete image</span>
      </div>`;
    });
  }
</script>

{% comment %} Project operations {% endcomment %}
<script>
  // Add this near the top of your JavaScript
  const CURRENT_USER_ID = "{{ request.user.id|escapejs }}";

  function toggleDropdown(dropdownId) {
    document.getElementById(dropdownId).classList.toggle("show");
  }

  window.onclick = function (event) {
    if (!event.target.matches(".dropdown button")) {
      var dropdowns =
        document.getElementsByClassName("dropdown-content");
      for (var i = 0; i < dropdowns.length; i++) {
        var openDropdown = dropdowns[i];
        if (openDropdown.classList.contains("show")) {
          openDropdown.classList.remove("show");
        }
      }
    }
  };

  function sortTable(column) {
    var table, rows, switching, i, x, y, shouldSwitch;
    table = document.getElementById("projectTable");
    switching = true;
    while (switching) {
      switching = false;
      rows = table.rows;
      for (i = 1; i < rows.length - 1; i++) {
        shouldSwitch = false;
        x =
          rows[i].getElementsByTagName("TD")[
            column === "name" ? 0 : column === "date" ? 1 : 2
          ];
        y =
          rows[i + 1].getElementsByTagName("TD")[
            column === "name" ? 0 : column === "date" ? 1 : 2
          ];
        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
          shouldSwitch = true;
          break;
        }
      }
      if (shouldSwitch) {
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
      }
    }
  }

  function filterTable(status) {
    var table, tr, td, i, txtValue;
    table = document.getElementById("projectTable");
    tr = table.getElementsByTagName("tr");
    for (i = 0; i < tr.length; i++) {
      td = tr[i].getElementsByTagName("td")[2];
      if (td) {
        txtValue = td.textContent || td.innerText;
        if (
          status === "all" ||
          txtValue.toLowerCase().indexOf(status.toLowerCase()) > -1
        ) {
          tr[i].style.display = "";
        } else {
          tr[i].style.display = "none";
        }
      }
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    const newProjectButton = document.getElementById('newProjectButton');
    const projectTable = document.getElementById('projectTable').getElementsByTagName('tbody')[0];

    newProjectButton.addEventListener('click', createNewProject);

    // Fetch and display projects on page load
    fetchProjects();

    function fetchProjects() {
        fetch('/core/projects/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        })
        .then(response => response.json())
        .then(data => {
            projectTable.innerHTML = ''; // Clear existing rows
            data.projects.forEach(project => {
                insertProjectRow(project.name, project.id, project.created_at, project.status);
            });
        })
        .catch(error => {
            console.error('Error fetching projects:', error);
        });
    }

    function insertProjectRow(projectName, projectId, createdAt, status) {
      const newRow = document.createElement('tr');
      newRow.classList.add('project-row');
      newRow.innerHTML = `
          <td class="py-2"><span class="project-name" data-project-id="${projectId}">${projectName}</span></td>
          <td class="py-2">${createdAt}</td>
          <td class="py-2"><span class="text-yellow-600">${status}</span></td>
          <td class="py-2">
              <div class="flex items-center space-x-2">
                  <button class="edit-project text-indigo-600 hover:text-indigo-800" data-project-id="${projectId}">
                      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                      </svg>
                  </button>
                  <button class="text-green-600 hover:text-green-800">
                      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                      </svg>
                  </button>
                  <button class="delete-project text-red-600 hover:text-red-800" data-project-id="${projectId}">
                      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                  </button>
                  <button class="text-gray-500 hover:text-gray-700">
                      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                      </svg>
                  </button>
              </div>
          </td>
      `;
  
      projectTable.appendChild(newRow);
      addProjectEventListeners(newRow);
  }

    function createNewProject() {
        fetch('/core/create-new-project/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                fetchProjects(); // Refresh the project list
            } else {
                console.error('Failed to create new project:', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
  
    function addProjectEventListeners(row) {
      const projectNameSpan = row.querySelector('.project-name');
      const deleteButton = row.querySelector('.delete-project');
      const editButton = row.querySelector('.edit-project');
  
      projectNameSpan.addEventListener('click', function() {
          const projectId = this.dataset.projectId;
          const currentName = this.textContent;
          const newName = prompt('Enter new project name:', currentName);
          if (newName && newName !== currentName) {
              renameProject(projectId, newName, this);
          }
      });
  
      deleteButton.addEventListener('click', function() {
          const projectId = this.dataset.projectId;
          if (confirm('Are you sure you want to delete this project?')) {
              deleteProject(projectId, row);
          }
      });
  
      editButton.addEventListener('click', function() {
        const projectId = this.dataset.projectId;
        console.log('Navigating to edit page for project:', projectId);
        // Use the upload_tiff URL pattern but with edit context
        window.location.href = `/tif-editor/projects/${CURRENT_USER_ID}/${projectId}/edit/`;
    });
  }
  
    function renameProject(projectId, newName, element) {
      fetch(`/core/projects/${projectId}/rename/`, {
        method: 'PUT',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name: newName })
      })
      .then(response => response.json())
      .then(data => {
        if (data.message === 'Project renamed successfully') {
          element.textContent = newName;
        } else {
          console.error('Failed to rename project:', data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }
  
    function deleteProject(projectId, row) {
      row.classList.add('fade-out');
      setTimeout(() => {
        fetch(`/core/projects/${projectId}/delete/`, {
          method: 'DELETE',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.message === 'Project deleted successfully') {
            row.remove();
          } else {
            console.error('Failed to delete project:', data.error);
            row.classList.remove('fade-out');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          row.classList.remove('fade-out');
        });
      }, 300);
    }
  
    // Add event listeners to existing rows
    const existingRows = projectTable.getElementsByTagName('tr');
    for (let row of existingRows) {
      row.classList.add('project-row');
      addProjectEventListeners(row);
    }
  
    // Function to get CSRF token from cookies
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }            
  });
</script>